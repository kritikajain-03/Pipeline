name: Validate PR on develop branch

on:
  pull_request:
    types: [opened, synchronize]
    branches: [develop]
    paths:
      - 'force-app/**'

jobs:
  validate-deployment-on-develop-org:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}

    steps:
      # -------------------------------
      # Setup Node
      # -------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # -------------------------------
      # Checkout Code
      # -------------------------------
      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # -------------------------------
      # Read PR Body â†’ extract test classes
      # -------------------------------
      - name: Read PR Body
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "$PR_BODY" > pr_body.txt
          node ./parsePR.js
          TESTS=$(cat testsToRun.txt)
          echo "APEX_TESTS=$TESTS" >> $GITHUB_ENV
          echo "Tests to run: $TESTS"

      # -------------------------------
      # Install Salesforce CLI
      # -------------------------------
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      # -------------------------------
      # Authenticate to Integration Org
      # -------------------------------
      - name: Authenticate to Integration Org
        shell: bash
        run: |
          echo "${{ secrets.SFDX_INTEGRATION_URL }}" > SFDX_URL.txt
          sf org login sfdx-url --sfdx-url-file SFDX_URL.txt --alias integration --set-default

      # -------------------------------
      # Run SPECIFIED Apex Tests
      # -------------------------------
      - name: Run specified Apex tests
        if: ${{ env.APEX_TESTS != 'all' }}
        run: |
          sf apex test run \
            --test-level RunSpecifiedTests \
            --tests ${{ env.APEX_TESTS }} \
            --wait 30 \
            --code-coverage \
            --json

      # -------------------------------
      # Run ALL Apex Tests
      # -------------------------------
      - name: Run all Apex tests
        if: ${{ env.APEX_TESTS == 'all' }}
        run: |
          sf apex test run \
            --test-level RunLocalTests \
            --wait 30 \
            --code-coverage \
            --json
