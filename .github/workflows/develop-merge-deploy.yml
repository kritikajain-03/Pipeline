name: Deploy Develop Branch to Integration

on:
  push:
    branches: [develop]
    paths:
      - 'force-app/**'

jobs:
  deploy-develop:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Salesforce CLI
      run: npm install -g @salesforce/cli@latest

    # Authenticate
    - name: Authenticate to Integration Org
      run: |
        echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
        sf org login jwt \
          --client-id ${{ secrets.CONSUMER_KEY }} \
          --jwt-key-file server.key \
          --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
          --instance-url ${{ vars.INSTANCE_URL }} \
          --alias integration

    # Identify changed metadata
    - name: Create delta packages
      run: |
        mkdir changed-sources
        sfdx sgd:source:delta --to HEAD --from HEAD^ --output changed-sources/ --generate-delta --source force-app/

    # Deploy changed metadata
    - name: Deploy delta metadata
      run: |
        sfdx force:source:deploy -p "changed-sources/force-app" --testlevel RunLocalTests --json

    # Deploy destructive changes
    - name: Deploy destructive changes
      run: |
        sfdx force:mdapi:deploy -d "changed-sources/destructiveChanges" --ignorewarnings
