# Unique name for this workflow
name: Validate and Generate Report

# Trigger: run on PRs to develop branch
on:
  pull_request:
    types: [opened, synchronize]
    branches: [ develop ]
    paths:
      - 'force-app/**'

jobs:
  validate-and-report:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      - name: Install sfdx-git-delta plugin
        run: echo 'y' | sfdx plugins:install sfdx-git-delta

      - name: Install Java
        run: |
          sudo apt-get update
          sudo apt install default-jdk

      - name: Install SFDX scanner
        run: sf plugins install @salesforce/sfdx-scanner --force

      - name: Populate auth file with SFDX_URL secret of integration org
        shell: bash
        run: |
          echo ${{ secrets.SFDX_INTEGRATION_URL}} > ./SFDX_INTEGRATION_URL.txt

      - name: Authenticate to Integration Org
        run: sfdx auth:sfdxurl:store -f ./SFDX_INTEGRATION_URL.txt -s -a integration

      - name: Create delta packages
        run: |
          mkdir changed-sources
          sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/

      - name: Run tests and capture JSON
        run: |
          sf project deploy start \
            --manifest "changed-sources/package/package.xml" \
            --dry-run \
            --test-level RunLocalTests \
            --json > testResults.json

      - name: Parse test results into HTML report
        run: |
          node ./scripts/parseTestResults.js testResults.json report.html

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: Test-Validation-Report
          path: report.html
