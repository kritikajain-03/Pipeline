name: Validate PR on develop branch

on:
  pull_request:
    branches: [develop]
    paths:
      - 'force-app/**'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Salesforce CLI
      run: npm install -g @salesforce/cli@latest

    - name: Authenticate to Salesforce Org
      run: |
        echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
        sf org login jwt \
          --client-id ${{ secrets.CONSUMER_KEY }} \
          --jwt-key-file server.key \
          --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
          --instance-url ${{ vars.INSTANCE_URL }} \
          --alias testOrg

    # üî¥ STEP 1: Extract test classes from PR body
    - name: Extract Apex Tests from PR Description
      run: node .github/scripts/extract-tests.js

    # üî¥ STEP 2: Run only selected tests
    - name: Run Apex Tests
      run: |
        TESTS=$(cat testsToRun.txt)

        if [ "$TESTS" = "all" ]; then
          echo "Running all local tests"
          sf apex test run \
            --target-org testOrg \
            --test-level RunLocalTests \
            --code-coverage \
            --result-format json \
            --wait 30 > test_results.json
        else
          echo "Running selected tests: $TESTS"
          sf apex test run \
            --target-org testOrg \
            --tests "$TESTS" \
            --code-coverage \
            --result-format json \
            --wait 30 > test_results.json
        fi

    # üî¥ STEP 3: Fail job if any test fails
    - name: Fail if Apex tests failed
      run: |
        FAILURES=$(jq '.result.summary.failing' test_results.json)

        if [ "$FAILURES" -gt 0 ]; then
          echo "‚ùå Apex tests failed"
          exit 1
        fi

    # üî¥ STEP 4: Enforce 75% coverage
    - name: Enforce Coverage Threshold
      run: |
        COVERAGE=$(jq '
          ([.result.coverage.coverage[].percentCovered] | add / length)
        ' test_results.json)

        echo "Coverage: $COVERAGE%"

        if (( $(echo "$COVERAGE < 75" | bc -l) )); then
          echo "‚ùå Coverage below 75%"
          exit 1
        fi

    # STEP 5: Generate Report (always runs)
    - name: Generate Validation Report
      if: always()
      run: |
        echo "<html><body><h1>Validation Report</h1>" > validation_report.html
        echo "<pre>" >> validation_report.html
        cat test_results.json >> validation_report.html
        echo "</pre></body></html>" >> validation_report.html

    - name: Upload Validation Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: salesforce-validation-report
        path: validation_report.html
