name: Validate PR on Develop Branch

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize]
    paths:
      - 'force-app/**'

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}

    steps:
    # -------------------------------
    # Checkout PR code
    # -------------------------------
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # -------------------------------
    # Setup Node
    # -------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # -------------------------------
    # Install tools
    # -------------------------------
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Install Salesforce CLI
      run: npm install -g @salesforce/cli@latest

    # -------------------------------
    # Authenticate (JWT)
    # -------------------------------
    - name: Authenticate Org
      run: |
        echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
        sf org login jwt \
          --client-id ${{ secrets.CONSUMER_KEY }} \
          --jwt-key-file server.key \
          --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
          --instance-url ${{ vars.INSTANCE_URL }} \
          --alias targetOrg

    # -------------------------------
    # Extract tests from PR (your script)
    # -------------------------------
    - name: Extract Apex Tests from PR
      run: node .github/scripts/extract-tests.js

    - name: Load test list
      run: |
        TESTS=$(cat testsToRun.txt)
        echo "APEX_TESTS=$TESTS" >> $GITHUB_ENV

    # -------------------------------
    # Initialize flags
    # -------------------------------
    - name: Initialize flags
      run: |
        echo "VALIDATION_FAILED=0" >> $GITHUB_ENV

    # -------------------------------
    # Validate PR code with specified tests
    # -------------------------------
    - name: Validate PR code with specified tests
      if: ${{ env.APEX_TESTS != 'all' }}
      run: |
        sf project deploy start \
          --target-org targetOrg \
          --source-dir force-app \
          --test-level RunSpecifiedTests \
          --tests "$APEX_TESTS" \
          --wait 30 \
          --json > deploy_result.json 2> deploy_error.txt || true

    # -------------------------------
    # Evaluate deployment result
    # -------------------------------
    - name: Evaluate Validation Result
      run: |
        STATUS=$(jq -r '.result.status // "Failed"' deploy_result.json 2>/dev/null)

        echo "Deployment Status: $STATUS"

        if [ -s deploy_error.txt ]; then
          echo "❌ Deployment validation error"
          echo "VALIDATION_FAILED=1" >> $GITHUB_ENV
          exit 1
        fi

        if [ "$STATUS" != "Succeeded" ] && [ "$STATUS" != "SucceededPartial" ]; then
          echo "❌ PR validation failed"
          echo "VALIDATION_FAILED=1" >> $GITHUB_ENV
          exit 1
        fi

        echo "✅ PR validation passed"

    # -------------------------------
    # Generate HTML report
    # -------------------------------
    - name: Generate Validation Report
      if: always()
      run: |
        echo "<html><body style='font-family:Arial'>" > validation_report.html
        echo "<h1>Salesforce PR Validation Report</h1>" >> validation_report.html

        echo "<p><b>Test Class Name :</b> $APEX_TESTS</p>" >> validation_report.html

        if [ -s deploy_error.txt ]; then
          echo "<p style='color:red'><b>Error :</b></p><pre>" >> validation_report.html
          sed 's/\x1b \[[0-9;]*m//g' deploy_error.txt >> validation_report.html
          echo "</pre>" >> validation_report.html
        else
          echo "<p style='color:green'><b>Error :</b> None</p>" >> validation_report.html
        fi

        if [ "$VALIDATION_FAILED" = "1" ]; then
          echo "<h3 style='color:red'>❌ PR Validation Failed</h3>" >> validation_report.html
        else
          echo "<h3 style='color:green'>✅ PR Validation Passed</h3>" >> validation_report.html
        fi

        echo "</body></html>" >> validation_report.html

    # -------------------------------
    # Upload report
    # -------------------------------
    - name: Upload Validation Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: salesforce-pr-validation-report
        path: validation_report.html
