name: Validate PR on Develop Branch

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize]
    paths:
      - 'force-app/**'

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}

    steps:
    # -------------------------------
    # Checkout PR code
    # -------------------------------
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # -------------------------------
    # Setup Node
    # -------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # -------------------------------
    # Install tools
    # -------------------------------
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Install Salesforce CLI
      run: npm install -g @salesforce/cli@latest

    # -------------------------------
    # Authenticate (JWT)
    # -------------------------------
    - name: Authenticate Org
      run: |
        echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
        sf org login jwt \
          --client-id ${{ secrets.CONSUMER_KEY }} \
          --jwt-key-file server.key \
          --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
          --instance-url ${{ vars.INSTANCE_URL }} \
          --alias targetOrg

    # -------------------------------
    # Extract tests from PR (your script)
    # -------------------------------
    - name: Extract Apex Tests from PR
      run: node .github/scripts/extract-tests.js

    - name: Load test list
      run: |
        TESTS=$(cat testsToRun.txt)
        echo "APEX_TESTS=$TESTS" >> $GITHUB_ENV

    # -------------------------------
    # Initialize flags
    # -------------------------------
    - name: Initialize flags
      run: |
        echo "VALIDATION_FAILED=0" >> $GITHUB_ENV

    # ... (Previous steps remain the same until Validate PR code)

    # -------------------------------
    # Check-only deploy PR code + tests
    # -------------------------------
    - name: Validate PR code
      id: validate_step
      run: |
        # Combined logic: check if APEX_TESTS is 'all' or specific
        TEST_LEVEL="RunSpecifiedTests"
        TEST_PARAM="--tests $APEX_TESTS"
        
        if [ "$APEX_TESTS" = "all" ]; then
          TEST_LEVEL="RunLocalTests"
          TEST_PARAM=""
        fi

        sf project deploy start \
          --target-org targetOrg \
          --source-dir force-app \
          --test-level $TEST_LEVEL \
          $TEST_PARAM \
          --dry-run \
          --wait 30 \
          --json > deploy_result.json 2> deploy_error.txt || echo "Validation command execution finished"

    # -------------------------------
    # Evaluate deployment result
    # -------------------------------
    - name: Evaluate Validation Result
      id: evaluate
      run: |
        # Extract status and error message using jq
        STATUS=$(jq -r '.result.status' deploy_result.json)
        # Extract detailed error messages (component or test failures)
        ERROR_MSG=$(jq -r '.message // .result.errorMessage // .result.details.componentFailures[0].problem // .result.details.runTestResult.failures[0].message // "No specific error message found"' deploy_result.json)
        
        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "error_msg=$ERROR_MSG" >> $GITHUB_OUTPUT

        if [ "$STATUS" != "Succeeded" ] && [ "$STATUS" != "SucceededPartial" ]; then
          echo "❌ PR validation failed: $STATUS"
          echo "VALIDATION_FAILED=1" >> $GITHUB_ENV
        else
          echo "✅ PR validation passed"
          echo "VALIDATION_FAILED=0" >> $GITHUB_ENV
        fi

    # -------------------------------
    # Generate HTML report
    # -------------------------------
    - name: Generate Validation Report
      if: always()
      run: |
        echo "<html><body style='font-family:Arial'>" > validation_report.html
        echo "<h1>Salesforce PR Validation Report</h1>" >> validation_report.html
        echo "<p><b>Test Class Name :</b> $APEX_TESTS</p>" >> validation_report.html

        if [ "$VALIDATION_FAILED" = "1" ]; then
          echo "<p style='color:red'><b>Error Details:</b></p>" >> validation_report.html
          echo "<pre>${{ steps.evaluate.outputs.error_msg }}</pre>" >> validation_report.html
          echo "<h3 style='color:red'>❌ PR Validation Failed</h3>" >> validation_report.html
        else
          echo "<p style='color:green'><b>Error :</b> None</p>" >> validation_report.html
          echo "<h3 style='color:green'>✅ PR Validation Passed</h3>" >> validation_report.html
        fi
        echo "</body></html>" >> validation_report.html

    # -------------------------------
    # Final Step: Fail the workflow to block Merge
    # -------------------------------
    - name: Check Final Status
      if: always()
      run: |
        if [ "$VALIDATION_FAILED" = "1" ]; then
          echo "Failing job to prevent merge..."
          exit 1
        fi