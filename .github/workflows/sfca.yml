name: Salesforce Validation Workflow

on:
  pull_request:
    paths:
      - 'force-app/**'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # -------------------------------
      # Setup Node
      # -------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # -------------------------------
      # Install Salesforce CLI
      # -------------------------------
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      # -------------------------------
      # Authenticate to Salesforce Org
      # -------------------------------
      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
          sf org login jwt \
            --client-id ${{ secrets.CONSUMER_KEY }} \
            --jwt-key-file server.key \
            --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
            --instance-url ${{ vars.INSTANCE_URL }} \
            --alias testOrg

      # -------------------------------
      # Run Apex Tests
      # -------------------------------
      - name: Run Apex Tests
        continue-on-error: true
        run: |
          sf apex test run \
            --target-org testOrg \
            --test-level RunLocalTests \
            --result-format json \
            --code-coverage \
            --wait 30 \
            > test_results.json 2>/dev/null

          if [ ! -s test_results.json ]; then
            echo '{"error":"Apex tests failed or no results"}' > test_results.json
          fi

      # -------------------------------
      # Extract Failing Tests
      # -------------------------------
      - name: Extract Failing Tests
        continue-on-error: true
        run: |
          jq -r '
            .result.tests[]?
            | select(.Outcome == "Fail")
            | "\(.ApexClass.Name) â†’ \(.MethodName): \(.Message)"
          ' test_results.json > failing_tests.txt || true

          if [ ! -s failing_tests.txt ]; then
            echo "No failing Apex tests ðŸŽ‰" > failing_tests.txt
          fi

      # -------------------------------
      # Validate Coverage (75%)
      # -------------------------------
      - name: Validate Coverage
        continue-on-error: true
        run: |
          TOTAL_COVERAGE=$(jq -r '
            if (.result.coverage.coverage | length) > 0
            then ([.result.coverage.coverage[].percentCovered] | add / length)
            else 0
            end
          ' test_results.json)

          echo "$TOTAL_COVERAGE" > coverage_value.txt

          if (( $(echo "$TOTAL_COVERAGE < 75" | bc -l) )); then
            echo "âŒ Coverage below 75%" > coverage_status.txt
          else
            echo "âœ… Coverage meets 75%" > coverage_status.txt
          fi

      # -------------------------------
      # Metadata Validation
      # -------------------------------
      - name: Validate Metadata Deployment
        continue-on-error: true
        run: |
          sf project deploy validate \
            --source-dir force-app \
            --target-org testOrg \
            --json \
            > metadata_validation.json 2>/dev/null

          if [ ! -s metadata_validation.json ]; then
            echo '{"error":"Metadata validation failed"}' > metadata_validation.json
          fi

      # -------------------------------
      # Generate SINGLE Validation Report
      # -------------------------------
      - name: Generate Validation Report
        run: |
          COVERAGE=$(cat coverage_value.txt)
          STATUS=$(cat coverage_status.txt)

          echo "<html><body style='font-family: Arial'>" > validation_report.html
          echo "<h1>Salesforce Validation Report</h1>" >> validation_report.html

          echo "<h2>Failing Apex Tests</h2><pre>" >> validation_report.html
          cat failing_tests.txt >> validation_report.html
          echo "</pre>" >> validation_report.html

          echo "<h2>Apex Test Coverage</h2>" >> validation_report.html
          echo "<p><b>Coverage:</b> $COVERAGE%</p>" >> validation_report.html
          echo "<p><b>Status:</b> $STATUS</p>" >> validation_report.html

          echo "<h2>Metadata Validation</h2><pre>" >> validation_report.html
          cat metadata_validation.json >> validation_report.html
          echo "</pre></body></html>" >> validation_report.html

      # -------------------------------
      # Upload Report
      # -------------------------------
      - name: Upload Validation Report
        uses: actions/upload-artifact@v4
        with:
          name: salesforce-validation-report
          path: validation_report.html
