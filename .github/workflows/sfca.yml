name: Validate PR on Develop Branch

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize]
    paths:
      - 'force-app/**'

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}

    steps:
    # -------------------------------
    # Checkout PR code
    # -------------------------------
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # -------------------------------
    # Setup Node
    # -------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # -------------------------------
    # Install tools
    # -------------------------------
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Install Salesforce CLI
      run: npm install -g @salesforce/cli@latest

    # -------------------------------
    # Authenticate (JWT)
    # -------------------------------
    - name: Authenticate Org
      run: |
        echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
        sf org login jwt \
          --client-id ${{ secrets.CONSUMER_KEY }} \
          --jwt-key-file server.key \
          --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
          --instance-url ${{ vars.INSTANCE_URL }} \
          --alias targetOrg

    # -------------------------------
    # Extract tests from PR (your script)
    # -------------------------------
    - name: Extract Apex Tests from PR
      run: node .github/scripts/extract-tests.js

    - name: Load test list
      run: |
        TESTS=$(cat testsToRun.txt)
        echo "APEX_TESTS=$TESTS" >> $GITHUB_ENV

# -----------------------------------------------------------
      # Validation Step (The || true is critical here)
      # -----------------------------------------------------------
    - name: Validate PR code
      run: |
        TEST_LEVEL="RunSpecifiedTests"
        if [ "$APEX_TESTS" = "all" ]; then
          TEST_LEVEL="RunLocalTests"
          EXTRA_ARGS=""
        else
          TEST_LEVEL="RunSpecifiedTests"
          EXTRA_ARGS="--tests $APEX_TESTS"
        fi
        sf project deploy start \
          --target-org targetOrg \
          --source-dir force-app \
          --test-level $TEST_LEVEL \
          $EXTRA_ARGS \
          --dry-run \
          --wait 30 \
          --json > deploy_result.json 2> deploy_error.txt || true

      # -----------------------------------------------------------
      # Evaluate Result (Check Coverage and Test Success)
      # -----------------------------------------------------------
    - name: Evaluate Validation Result
      run: |
        # 1. Check for CLI/Network errors
        if [ ! -f deploy_result.json ]; then
          echo "❌ Critical Error: deploy_result.json not found."
          echo "VALIDATION_FAILED=1" >> $GITHUB_ENV
          exit 1
        fi

        # 2. Parse JSON for status and coverage
        STATUS=$(jq -r '.result.status' deploy_result.json)
        COVERAGE=$(jq -r '.result.details.runTestResult.codeCoverageCheckPassed // "true"' deploy_result.json)
        
        echo "Deployment Status: $STATUS"
        echo "Coverage Passed: $COVERAGE"
        if [ "$STATUS" != "Succeeded" ] || [ "$COVERAGE" = "false" ]; then
          echo "❌ PR validation failed (Test failure or Coverage < 75%)"
          echo "VALIDATION_FAILED=1" >> $GITHUB_ENV
            
          # Extract specific error messages for the log
          jq -r '.result.details.componentFailures[].problem // .result.errorMessage' deploy_result.json > error_summary.txt
          exit 1
        else
          echo "✅ PR validation passed"
          echo "VALIDATION_FAILED=0" >> $GITHUB_ENV
        fi

      # -----------------------------------------------------------
      # Generate HTML report
      # -----------------------------------------------------------
    - name: Generate Validation Report
      if: always()
      run: |
        echo "<html><body style='font-family:Arial; padding:20px;'>" > validation_report.html
        echo "<h1>Salesforce PR Validation Report</h1>" >> validation_report.html
        echo "<p><b>Test Classes Run:</b> $APEX_TESTS</p>" >> validation_report.html
        if [ "$VALIDATION_FAILED" = "1" ]; then
          echo "<h3 style='color:red'>❌ PR Validation Failed</h3>" >> validation_report.html
          echo "<p><b>Reason:</b> Check for failed tests or Code Coverage < 75%.</p>" >> validation_report.html
          echo "<h4>Error Details:</h4><pre style='background:#f4f4f4;border:1px solid #ddd;padding:10px;'>" >> validation_report.html
           
          # Safely capture the error message from JSON
          if [ -f deploy_result.json ]; then
             jq -r '.result.details.componentFailures[].problem // .result.errorMessage' deploy_result.json >> validation_report.html
             jq -r '.result.details.runTestResult.failures[].message' deploy_result.json >> validation_report.html
          else
            cat deploy_error.txt >> validation_report.html
          fi
            echo "</pre>" >> validation_report.html
        else
          echo "<h3 style='color:green'>✅ PR Validation Passed</h3>" >> validation_report.html
          echo "<p>Tests passed and code coverage requirements met.</p>" >> validation_report.html
        fi

        echo "</body></html>" >> validation_report.html


    #Upload Validation Report
    - name: Upload Validation Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: salesforce-pr-validation-report
        path: validation_report.html
