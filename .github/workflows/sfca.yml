name: Validate PR on Develop Branch

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize]
    paths:
      - 'force-app/**'

jobs:
  validate-pr:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------
    # Checkout repository
    # -------------------------------
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    # -------------------------------
    # Setup Node.js
    # -------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # -------------------------------
    # Install system tools
    # -------------------------------
    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    # -------------------------------
    # Install Salesforce CLI
    # -------------------------------
    - name: Install Salesforce CLI
      run: npm install -g @salesforce/cli@latest

    # -------------------------------
    # Authenticate to Salesforce (JWT)
    # -------------------------------
    - name: Authenticate Org
      run: |
        echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
        sf org login jwt \
          --client-id ${{ secrets.CONSUMER_KEY }} \
          --jwt-key-file server.key \
          --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
          --instance-url ${{ vars.INSTANCE_URL }} \
          --alias testOrg

    # -------------------------------
    # Extract Apex Tests from PR
    # -------------------------------
    - name: Extract Apex Tests
      run: node .github/scripts/extract-tests.js

    # -------------------------------
    # Initialize failure flags
    # -------------------------------
    - name: Initialize flags
      run: |
        echo "TEST_FAILURES=0" >> $GITHUB_ENV
        echo "COVERAGE_FAILURE=0" >> $GITHUB_ENV

    # -------------------------------
    # Run Apex Tests
    # -------------------------------
    - name: Run Apex Tests
      run: |
        TESTS=$(cat testsToRun.txt)
        if [ "$TESTS" = "all" ]; then
          sf apex test run \
            --target-org testOrg \
            --code-coverage \
            --result-format json \
            --wait 30 > test_results.json 2> test_error.txt || true
        else
          sf apex test run \
            --target-org testOrg \
            --tests "$TESTS" \
            --code-coverage \
            --result-format json \
            --wait 30 > test_results.json 2> test_error.txt || true
        fi


    # -------------------------------
    # Evaluate Test Results
    # -------------------------------
    - name: Evaluate Apex Test Results
      run: |
        TEST_FAILURES=0
        COVERAGE_FAILURE=0

        if [ -f test_results.json ]; then
          FAILING=$(jq '.result.summary.failing // 0' test_results.json)
          ORG_COVERAGE=$(jq -r '.result.summary.orgWideCoverage // 0' test_results.json)
          ORG_COVERAGE=${ORG_COVERAGE%\%}

          if [ "$FAILING" -gt 0 ]; then
            TEST_FAILURES=1
          fi
          if (( $(echo "$ORG_COVERAGE < 75" | bc -l) )); then
            COVERAGE_FAILURE=1
          fi
        else
          TEST_FAILURES=1
          COVERAGE_FAILURE=1
        fi

        echo "TEST_FAILURES=$TEST_FAILURES" >> $GITHUB_ENV
        echo "COVERAGE_FAILURE=$COVERAGE_FAILURE" >> $GITHUB_ENV


    # -------------------------------
    # Enforce 75% Org-Wide Coverage
    # -------------------------------
    - name: Enforce 75% Org Coverage
      run: |
        if [ -f test_results.json ]; then
          ORG_COVERAGE=$(jq -r '.result.summary.orgWideCoverage // 0' test_results.json)
          ORG_COVERAGE=${ORG_COVERAGE%\%}
          echo "Org Wide Coverage: $ORG_COVERAGE%"

          if [ "$ORG_COVERAGE" -lt 75 ]; then
            echo "COVERAGE_FAILURE=1" >> $GITHUB_ENV
            echo "❌ Org wide coverage below 75%"
          fi
        else
          echo "COVERAGE_FAILURE=1" >> $GITHUB_ENV
        fi


    # -------------------------------
    # Generate Validation Report
    # -------------------------------
    - name: Generate Validation Report
      if: always()
      run: |
        echo "<html><body style='font-family: Arial'>" > validation_report.html
        echo "<h1>Salesforce PR Validation Report</h1>" >> validation_report.html

        if [ -f test_results.json ]; then
          TESTS_RAN=$(jq '.result.summary.testsRan // 0' test_results.json)
          PASSING=$(jq '.result.summary.passing // 0' test_results.json)
          FAILING=$(jq '.result.summary.failing // 0' test_results.json)
          COVERAGE=$(jq -r '.result.summary.orgWideCoverage // 0' test_results.json)

          echo "<h2>Apex Test Summary</h2>" >> validation_report.html
          echo "<p><b>Tests Ran:</b> $TESTS_RAN</p>" >> validation_report.html
          echo "<p><b>Passing:</b> $PASSING</p>" >> validation_report.html
          echo "<p><b>Failing:</b> $FAILING</p>" >> validation_report.html
          echo "<p><b>Org-Wide Coverage:</b> $COVERAGE</p>" >> validation_report.html

          if [ "$FAILING" -gt 0 ]; then
            echo "<h3 style='color:red'>❌ Failed Tests:</h3><pre>" >> validation_report.html
            jq '.result.tests[] | select(.outcome=="Fail")' test_results.json >> validation_report.html
            echo "</pre>" >> validation_report.html
          fi
        else
          echo "<h3 style='color:red'>❌ No test results generated (compilation failure?)</h3>" >> validation_report.html
        fi

        # CLI Errors
        if [ -s test_error.txt ]; then
          echo "<h3>CLI Errors:</h3><pre>" >> validation_report.html
          cat test_error.txt >> validation_report.html
          echo "</pre>" >> validation_report.html
        fi

        # Status
        if [ "$TEST_FAILURES" = "1" ]; then
          echo "<h3 style='color:red'>❌ Apex tests failed</h3>" >> validation_report.html
        else
          echo "<h3 style='color:green'>✅ Apex tests passed</h3>" >> validation_report.html
        fi

        if [ "$COVERAGE_FAILURE" = "1" ]; then
          echo "<h3 style='color:red'>❌ Org-wide coverage below 75%</h3>" >> validation_report.html
        else
          echo "<h3 style='color:green'>✅ Org-wide coverage ≥ 75%</h3>" >> validation_report.html
        fi

        echo "</body></html>" >> validation_report.html



    # -------------------------------
    # Upload Validation Report
    # -------------------------------
    - name: Upload Validation Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: salesforce-validation-report
        path: validation_report.html


    # -------------------------------
    # Final PR Gate (FAIL / PASS)
    # -------------------------------
    - name: PR Gate (show status)
      run: |
        echo "TEST_FAILURES=$TEST_FAILURES"
        echo "COVERAGE_FAILURE=$COVERAGE_FAILURE"
        echo "❌ PR validation failed (if flags are set, check report)"

