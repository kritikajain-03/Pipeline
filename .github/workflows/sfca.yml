name: Validate PR on develop branch

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - develop
    paths:
      - 'force-app/**'

jobs:
  validate-deployment-on-develop-org:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'dependabot[bot]' }}

    steps:
    # ----------------------------------------------------
    # Checkout
    # ----------------------------------------------------
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ----------------------------------------------------
    # Setup Node
    # ----------------------------------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # ----------------------------------------------------
    # Read PR Body (Tests)
    # ----------------------------------------------------
    - name: Extract Apex tests from PR
      env:
        PR_BODY: ${{ github.event.pull_request.body }}
      run: |
        echo "$PR_BODY" > pr_body.txt

        cat << 'EOF' > parsePR.js
        const fs = require('fs');
        const body = fs.readFileSync('pr_body.txt','utf8');
        const match = body.match(/Apex::\[(.*?)\]::Apex/);
        let tests = 'all';
        if (match && match[1]) tests = match[1].trim();
        fs.writeFileSync('testsToRun.txt', tests);
        EOF

        node parsePR.js
        echo "APEX_TESTS=$(cat testsToRun.txt)" >> $GITHUB_ENV

    # ----------------------------------------------------
    # Install Salesforce CLI
    # ----------------------------------------------------
    - name: Install Salesforce CLI
      run: |
        npm install -g @salesforce/cli
        sf version

    # ----------------------------------------------------
    # JWT Authentication
    # ----------------------------------------------------
    - name: Authenticate to Salesforce
      run: |
        echo "${{ secrets.JWT_SERVER_KEY }}" > server.key

        sf org login jwt \
          --client-id ${{ secrets.CONSUMER_KEY }} \
          --jwt-key-file server.key \
          --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
          --instance-url ${{ vars.INSTANCE_URL }} \
          --alias integration \
          --set-default

    # ----------------------------------------------------
    # Install sfdx-git-delta
    # ----------------------------------------------------
    - name: Install git-delta
      run: sf plugins install sfdx-git-delta

    # ----------------------------------------------------
    # Create delta
    # ----------------------------------------------------
    - name: Create delta package
      run: |
        mkdir changed-sources reports
        sf sgd source delta \
          --to HEAD \
          --from HEAD^ \
          --output changed-sources \
          --generate-delta \
          --source force-app

    # ----------------------------------------------------
    # Java + Scanner
    # ----------------------------------------------------
    - name: Install Java
      run: sudo apt-get install -y default-jdk

    - name: Install Salesforce Scanner
      run: sf plugins install @salesforce/sfdx-scanner

    # ----------------------------------------------------
    # Run Code Analyzer (Report)
    # ----------------------------------------------------
    - name: Run Apex Code Scan
      run: |
        sf scanner run \
          --target "changed-sources/**/*.cls" \
          --format sarif \
          --outfile reports/apex-scan.sarif

    - name: Upload Code Scan Report
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: reports/apex-scan.sarif

    # ----------------------------------------------------
    # Validate Deployment (Specified Tests)
    # ----------------------------------------------------
    - name: Validate with specified tests
      if: ${{ env.APEX_TESTS != 'all' }}
      run: |
        sf project deploy validate \
          --source-dir changed-sources/force-app \
          --test-level RunSpecifiedTests \
          --tests ${{ env.APEX_TESTS }} \
          --results-dir reports \
          --json > reports/deploy-validation.json

    # ----------------------------------------------------
    # Validate Deployment (All Tests)
    # ----------------------------------------------------
    - name: Validate with all tests
      if: ${{ env.APEX_TESTS == 'all' }}
      run: |
        sf project deploy validate \
          --source-dir changed-sources/force-app \
          --test-level RunLocalTests \
          --results-dir reports \
          --json > reports/deploy-validation.json

    # ----------------------------------------------------
    # Upload Validation & Test Reports
    # ----------------------------------------------------
    - name: Upload Validation Reports
      uses: actions/upload-artifact@v4
      with:
        name: salesforce-validation-report
        path: reports/
