name: Salesforce Code Analyzer Workflow

on:
  pull_request:
    paths:
      - 'force-app/main/default/classes/**'
      - 'sfca-config.yml'

# permissions:
#   contents: read
#   pull-requests: write
jobs:
  sfca:
    runs-on: ubuntu-latest
  
    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 
      - name: Setup Node 
        uses: actions/setup-node@v4 
        with: 
          node-version: '20'
      # -------------------------------
      # Install Salesforce CLI
      # -------------------------------
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest




      - name: Install Latest Salesforce Code Analyzer CLI Plugin 
        run: sf plugins install code-analyzer@latest
      - name: Verify Code Analyzer install
        run: |
            sf plugins
            sf plugins inspect code-analyzer || true
            sf code-analyzer run --help


      # -------------------------------
      # Authenticate to Org
      # -------------------------------
      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
          sf org login jwt \
            --client-id ${{ secrets.CONSUMER_KEY }} \
            --jwt-key-file server.key \
            --username ${{ secrets.DEPLOYMENT_USER_NAME }} \
            --instance-url ${{ vars.INSTANCE_URL }} \
            --alias testOrg



      # -------------------------------
      # 1. Run Apex Tests (Generates the missing file)
      # -------------------------------
      - name: Run Apex Tests
        continue-on-error: true
        run: |
          sf apex test run \
            --target-org testOrg \
            --test-level RunLocalTests \
            --result-format json \
            --code-coverage \
            --wait 30 \
            > test_results.json 2> test_errors.log

          if [ ! -s test_results.json ]; then
            echo '{"error":"Apex tests failed or no results"}' > test_results.json
          fi
      - name: Install bc
        run: sudo apt-get update && sudo apt-get install -y bc

      - name: Extract Failing Apex Test Classes
        continue-on-error: true
        run: |
          jq -r '
            .result.tests[]
            | select(.Outcome == "Fail")
            | "\(.ApexClass.Name) â†’ \(.MethodName): \(.Message)"
          ' test_results.json > failing_tests.txt || true

          if [ ! -s failing_tests.txt ]; then
            echo "No failing Apex tests ðŸŽ‰" > failing_tests.txt
          fi
  

      # -------------------------------
      # 2. Validate Coverage Threshold (Soft Fail)
      # -------------------------------
      - name: Validate Coverage Threshold (Soft Fail)
        continue-on-error: true
        run: |
          set +e   # IMPORTANT: disable immediate exit

          TOTAL_COVERAGE=$(jq -r '
            if (.result.coverage.coverage | length) > 0
            then ([.result.coverage.coverage[].percentCovered] | add / length)
            else 0
            end
          ' test_results.json 2>/dev/null)

          if [ -z "$TOTAL_COVERAGE" ] || [ "$TOTAL_COVERAGE" = "null" ]; then
            TOTAL_COVERAGE=0
          fi

          echo "Total Coverage: $TOTAL_COVERAGE%"
          echo "$TOTAL_COVERAGE" > coverage_value.txt

          if echo "$TOTAL_COVERAGE < 75" | bc -l | grep -q 1; then
            echo "âŒ Coverage below 75% threshold" > coverage_status.txt
          else
            echo "âœ… Coverage meets 75% threshold" > coverage_status.txt
          fi


      # -------------------------------
      # 3. Validate Metadata
      # -------------------------------
      - name: Validate Metadata Deployment
        continue-on-error: true
        run: |
          sf project deploy validate \
            --source-dir force-app \
            --target-org testOrg \
            --json \
            > metadata_validation.json 2> metadata_errors.log

          if [ ! -s metadata_validation.json ]; then
            echo '{"error":"Metadata validation failed"}' > metadata_validation.json
          fi


      # -------------------------------
      # 4. Generate Consolidated Validation Report
      # -------------------------------
      - name: Generate Validation Report
        run: |
          touch coverage_value.txt coverage_status.txt test_results.json metadata_validation.json

          COVERAGE=$(cat coverage_value.txt)
          STATUS=$(cat coverage_status.txt)

          echo "<html><body style='font-family: sans-serif;'><h1>Validation Report</h1>" > validation_report.html
          echo "<h2>Failing Apex Tests</h2><pre>" >> validation_report.html
          cat failing_tests.txt >> validation_report.html
          echo "</pre>" >> validation_report.html


          echo "<h2>Apex Test Coverage</h2>" >> validation_report.html
          echo "<p><strong>Coverage:</strong> $COVERAGE%</p>" >> validation_report.html
          echo "<p><strong>Status:</strong> $STATUS</p>" >> validation_report.html

          echo "<h2>Metadata Validation Results</h2><pre>" >> validation_report.html
          cat metadata_validation.json >> validation_report.html
          echo "</pre></body></html>" >> validation_report.html


      # -------------------------------
      # 5. Upload Validation Report
      # -------------------------------
      - name: Upload Validation Report
        uses: actions/upload-artifact@v4
        with:
          name: salesforce-validation-report
          path: validation_report.html
