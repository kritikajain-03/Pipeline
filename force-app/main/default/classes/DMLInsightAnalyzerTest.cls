@IsTest
private class DMLInsightAnalyzerTest {
    @TestSetup
    static void setupTestData() {
        Profile p = [SELECT Id FROM Profile WHERE Name='Standard User' LIMIT 1];
        List<User> users = new List<User>();
        for (Integer i = 1; i <= 3; i++) {
            users.add(new User(
                FirstName = 'Test' + i,
                LastName = 'User',
                Email = 'testuser' + i + '@example.com',
                Username = 'testuser' + i + '@example.com.' + System.currentTimeMillis(),
                Alias = 'tuser' + i,
                TimeZoneSidKey = 'GMT',
                LocaleSidKey = 'en_US',
                EmailEncodingKey = 'UTF-8',
                LanguageLocaleKey = 'en_US',
                ProfileId = p.Id
            ));
        }
        insert users;

        // Create Database_Audit__c records for testing spike logic
        List<Database_Audit__c> audits = new List<Database_Audit__c>();

        audits.add(new Database_Audit__c(jiceui
            User__c = users[0].Id,
            ObjectName__c = 'Account',
            Operation__c = 'Insert',
            Record_Count__c = 1200,
            LogDate__c = System.today()
        ));
        audits.add(new Database_Audit__c(
            User__c = users[1].Id,
            ObjectName__c = 'Contact',
            Operation__c = 'Update',
            Record_Count__c = 500,
            LogDate__c = System.today().addDays(-1)
        ));
        audits.add(new Database_Audit__c(
            User__c = users[1].Id,
            ObjectName__c = 'Contact',
            Operation__c = 'Update',
            Record_Count__c = 1500,
            LogDate__c = System.today()
        ));
        audits.add(new Database_Audit__c(
            User__c = users[2].Id,
            ObjectName__c = 'Opportunity',
            Operation__c = 'Delete',
            Record_Count__c = 50,
            LogDate__c = System.today()
        ));
        insert audits;
    }

    @IsTest
    static void testAnalyzerMetadata() {
        DMLInsightAnalyzer analyzer = new DMLInsightAnalyzer();
        Assert.areEqual('DML Operation Insight', analyzer.getRuleName());
        Assert.areEqual('DATABASE_OPERATION', analyzer.getCategory());
        Assert.areEqual(true, analyzer.isEnabled());
        Assert.areNotEqual(null, analyzer.getQuery());
    }

    @IsTest
    static void testEvaluateWithAlgorithm() {
        List<User> users = [SELECT Id FROM User];
        DMLInsightAnalyzer analyzer = new DMLInsightAnalyzer();

        Test.startTest();
        analyzer.evaluate(false, users);
        Test.stopTest();

        List<Security_Insight__c> insights = [
            SELECT Name, Severity__c, User__c, Operation__c, ResourceName__c FROM Security_Insight__c
        ];
        Assert.isTrue(insights.size() >= 2, 'At least 2 insights should be generated by algorithm');
    }

    //mocked AI based evalution
    @IsTest
    static void testEvaluateWithAI_Mock() {
        List<User> users = [SELECT Id FROM User LIMIT 2];
        String fakeJSON = '[{' +
            '"Id":"' + users[0].Id + '",' +
            '"IncidentDate":"2026-01-12",' +
            '"ObjectName":"Account",' +
            '"Operation":"Insert",' +
            '"Insight":"Inserted many records",' +
            '"Risk":"High",' +
            '"InsightTitle":"High-Volume Insert of Account Records",' +
            '"Recommendation":"Review insert logic"' +
        '},{' +
            '"Id":"' + users[1].Id + '",' +
            '"IncidentDate":"2026-01-12",' +
            '"ObjectName":"Contact",' +
            '"Operation":"Update",' +
            '"Insight":"Updated many records",' +
            '"Risk":"Medium",' +
            '"InsightTitle":"Medium-Volume Update of Contact Records",' +
            '"Recommendation":"Review update logic"' +
        '}]';

        // Override the GenAIUtil call by injecting fake JSON
        Test.startTest();
        List<DMLInsightAnalyzer.ResponseWrapper> parsedInsights =
            (List<DMLInsightAnalyzer.ResponseWrapper>) JSON.deserialize(fakeJSON, List<DMLInsightAnalyzer.ResponseWrapper>.class);

        List<Security_Insight__c> insightsToInsert = new List<Security_Insight__c>();
        for (DMLInsightAnalyzer.ResponseWrapper rw : parsedInsights) {
            Security_Insight__c si = new Security_Insight__c(
                Name = rw.InsightTitle,
                User__c = rw.Id,
                Description__c = rw.Insight,
                Incident_Date__c = rw.IncidentDate,
                Severity__c = rw.Risk,
                ResourceName__c = rw.ObjectName,
                ResourceType__c = 'Object',
                Recommendation__c = rw.Recommendation,
                Operation__c = rw.Operation
            );
            insightsToInsert.add(si);
        }
        insert insightsToInsert;
        Test.stopTest();

        List<Security_Insight__c> inserted = [
            SELECT Name, User__c, Severity__c
            FROM Security_Insight__c
        ];
        Assert.areEqual(2, inserted.size(), 'Two AI-based insights should be inserted');
    }

   //clean output
    @IsTest
    static void testCleanAIOutput() {
        Assert.areEqual('[]', DMLInsightAnalyzer.cleanAIOutput(null));
        Assert.areEqual('[]', DMLInsightAnalyzer.cleanAIOutput(''));
        Assert.isTrue(DMLInsightAnalyzer.cleanAIOutput('[{"Id":"001"}]').startsWith('['));
        Assert.isTrue(DMLInsightAnalyzer.cleanAIOutput('json[{"Id":"001"}]').startsWith('['));
    }
    
    //AI 
    @IsTest
    static void testCreateDMLInsightsWithAI_Coverage() {
        User u = [SELECT Id FROM User LIMIT 1];
        GenAIUtil.mockAIResponse =
            '[{' +
                '"Id":"' + u.Id + '",' +
                '"IncidentDate":"2026-01-12",' +
                '"ObjectName":"Account",' +
                '"Operation":"Insert",' +
                '"Insight":"Inserted &#39;many&#39; records",' +
                '"Risk":"High",' +
                '"InsightTitle":"High Insert",' +
                '"Recommendation":"Review inserts"' +
            '}]';
    
        Test.startTest();
        DMLInsightAnalyzer.createDMLInsightsWithAI(u.Id);
        Test.stopTest();
    
        List<Security_Insight__c> insights = [SELECT Name, Description__c, Severity__c FROM Security_Insight__c];
        Assert.areEqual(1, insights.size());
        Assert.areEqual('High', insights[0].Severity__c);
        Assert.isTrue(insights[0].Description__c.contains('many'));
    }
}